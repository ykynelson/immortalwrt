name: Fast OpenWrt Build for x86_64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-23.05
  TZ: Asia/Shanghai

jobs:
  # ä½¿ç”¨çŸ©é˜µç­–ç•¥ï¼Œå¯ä»¥åŒæ—¶ç¼–è¯‘å¤šä¸ªç›®æ ‡ï¼ˆè¿™é‡Œåªæœ‰ä¸€ä¸ªï¼‰
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    strategy:
      fail-fast: false
      matrix:
        target: [x86_64]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ä½¿ç”¨å¤šé‡ç¼“å­˜ç­–ç•¥
    - name: Setup build cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
          openwrt/dl
          openwrt/.ccache
        key: openwrt-${{ matrix.target }}-${{ github.sha }}
        restore-keys: |
          openwrt-${{ matrix.target }}-
          openwrt-

    - name: Setup toolchain cache
      uses: actions/cache@v4
      with:
        path: |
          openwrt/build_dir/host
          openwrt/build_dir/hostpkg
          openwrt/staging_dir/host
          openwrt/staging_dir/hostpkg
          openwrt/staging_dir/target-*
        key: toolchain-${{ matrix.target }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          toolchain-${{ matrix.target }}-

    - name: Maximize build space and speed
      run: |
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ (ä¼˜åŒ–å‰):"
        df -h
        
        # åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆæ›´æ¿€è¿›çš„æ¸…ç†ï¼‰
        sudo rm -rf \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache \
          /usr/local/share/boost \
          /usr/local/graalvm/ \
          /usr/local/.ghcup/ \
          /usr/local/share/powershell \
          /usr/local/share/chromium \
          /usr/local/lib/node_modules \
          /usr/share/swift \
          /tmp/* \
          /var/log/* \
          2>/dev/null || true
        
        # æ¸…ç†åŒ…ç®¡ç†å™¨
        sudo apt-get clean
        sudo apt-get autoremove -y
        
        # ä¼˜åŒ–ç³»ç»Ÿå‚æ•°
        echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
        echo 'vm.vfs_cache_pressure=50' | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p
        
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ (ä¼˜åŒ–åŽ):"
        df -h

    - name: Install dependencies (optimized)
      run: |
        # ä½¿ç”¨æ›´å¿«çš„é•œåƒæº
        sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
        sudo sed -i 's/http:\/\/archive\.ubuntu\.com\/ubuntu\//http:\/\/mirrors\.ustc\.edu\.cn\/ubuntu\//g' /etc/apt/sources.list
        
        # åªå®‰è£…ç»å¯¹å¿…éœ€çš„åŒ…
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends --no-install-suggests \
          build-essential clang flex g++ gawk gcc-multilib gettext git \
          libncurses5-dev libssl-dev python3-distutils rsync unzip \
          zlib1g-dev file wget ccache libelf-dev qemu-utils \
          time curl ca-certificates
        
        # ä¼˜åŒ–ccacheè®¾ç½®
        ccache --set-config=max_size=3G
        ccache --set-config=compression=true
        ccache --set-config=compression_level=6
        ccache --set-config=cache_dir=~/.ccache
        export CCACHE_DIR=~/.ccache
        export PATH="/usr/lib/ccache:$PATH"
        
        echo "ccacheç‰ˆæœ¬å’Œé…ç½®:"
        ccache --version
        ccache --show-config

    - name: Clone OpenWrt source
      run: |
        # æµ…å…‹éš†ä»¥å‡å°‘ä¸‹è½½æ—¶é—´å’Œç©ºé—´
        git clone $REPO_URL -b $REPO_BRANCH openwrt \
          --depth=1 \
          --single-branch \
          --filter=blob:none \
          --no-tags
        
        cd openwrt
        echo "æºç ä¿¡æ¯:"
        echo "åˆ†æ”¯: $(git branch --show-current)"
        echo "æäº¤: $(git log -1 --oneline)"
        echo "æºç å¤§å°: $(du -sh . 2>/dev/null || echo 'unknown')"

    - name: Load custom feeds
      run: |
        cd openwrt
        
        # å¯é€‰ï¼šæ·»åŠ ç¬¬ä¸‰æ–¹feedsä»¥èŽ·å–æ›´å¤šåŒ…
        # echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
        # echo 'src-git small https://github.com/kenzok8/small' >> feeds.conf.default
        
        # å¹¶è¡Œæ›´æ–°feeds
        echo "æ›´æ–°feeds..."
        time ./scripts/feeds update -a -j$(nproc)
        
        echo "å®‰è£…feeds..."
        time ./scripts/feeds install -a

    - name: Generate minimal config
      run: |
        cd openwrt
        
        # åˆ›å»ºæœ€å°åŒ–ä½†åŠŸèƒ½å®Œæ•´çš„é…ç½®
        cat > .config << 'EOF'
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_Generic=y
        
        # é•œåƒæ ¼å¼ - åªç”Ÿæˆéœ€è¦çš„
        CONFIG_EFI_IMAGES=n
        CONFIG_GRUB_IMAGES=y
        CONFIG_VMDK_IMAGES=n
        CONFIG_VDI_IMAGES=n
        CONFIG_QCOW2_IMAGES=n
        
        # ç¼–è¯‘ä¼˜åŒ–
        CONFIG_CCACHE=y
        CONFIG_DEVEL=y
        CONFIG_TOOLCHAINOPTS=y
        CONFIG_TARGET_OPTIONS=y
        CONFIG_KERNEL_BUILD_DOMAIN="buildhost"
        CONFIG_KERNEL_BUILD_USER="builder"
        
        # åŸºç¡€ç³»ç»Ÿ
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget-ssl=y
        CONFIG_PACKAGE_nano=y
        
        # æ–‡ä»¶å…±äº«
        CONFIG_PACKAGE_samba4-server=y
        CONFIG_PACKAGE_luci-app-samba4=y
        
        # å°è¯•åŒ…å«è¯·æ±‚çš„åº”ç”¨ï¼ˆå¦‚æžœä¸å­˜åœ¨ä¼šè¢«å¿½ç•¥ï¼‰
        CONFIG_PACKAGE_luci-app-openclash=m
        CONFIG_PACKAGE_luci-app-passwall=m
        
        # ä¼˜åŒ–ï¼šç¦ç”¨è°ƒè¯•å’Œä¸å¿…è¦çš„åŠŸèƒ½
        # CONFIG_COLLECT_KERNEL_DEBUG is not set
        # CONFIG_KERNEL_DEBUG_INFO is not set
        # CONFIG_KERNEL_DEBUG_KERNEL is not set
        # CONFIG_KERNEL_KALLSYMS is not set
        # CONFIG_PACKAGE_strace is not set
        # CONFIG_PACKAGE_valgrind is not set
        EOF
        
        # ç”Ÿæˆå®Œæ•´é…ç½®
        make defconfig V=s
        
        # æ˜¾ç¤ºå…³é”®é…ç½®
        echo "=== å…³é”®é…ç½®é¡¹ ==="
        grep "=y\|=m" .config | grep -E "(TARGET|PACKAGE_luci|PACKAGE_samba|CCACHE)" | head -20

    - name: Download packages with retry
      run: |
        cd openwrt
        
        # è®¾ç½®å¹¶è¡Œä¸‹è½½ï¼Œå¸¦é‡è¯•æœºåˆ¶
        download_with_retry() {
          local max_attempts=3
          local attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "ä¸‹è½½å°è¯• $attempt/$max_attempts"
            if make download -j$(($(nproc) * 2)) V=s; then
              echo "ä¸‹è½½æˆåŠŸ"
              return 0
            else
              echo "ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
              sleep 10
              ((attempt++))
            fi
          done
          
          echo "å¤šæ¬¡é‡è¯•åŽä»ç„¶å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ä¸‹è½½"
          make download -j1 V=s
        }
        
        time download_with_retry
        
        # æ¸…ç†æŸåçš„ä¸‹è½½æ–‡ä»¶
        find dl -size -1024c -exec ls -l {} \; -exec rm -f {} \;
        
        echo "ä¸‹è½½æ–‡ä»¶ç»Ÿè®¡:"
        find dl -type f | wc -l

    - name: Compile with maximum optimization
      run: |
        cd openwrt
        
        # è®¾ç½®ç¼–è¯‘çŽ¯å¢ƒ
        export PATH="/usr/lib/ccache:$PATH"
        export CCACHE_DIR=~/.ccache
        export FORCE_UNSAFE_CONFIGURE=1
        
        # è®¡ç®—æœ€ä¼˜çº¿ç¨‹æ•°
        JOBS=$(($(nproc) + 2))
        echo "ä½¿ç”¨ $JOBS ä¸ªç¼–è¯‘çº¿ç¨‹"
        echo "ç¼–è¯‘å¼€å§‹: $(date)"
        
        # ç¼–è¯‘è¿‡ç¨‹ç›‘æŽ§
        compile_with_monitoring() {
          # åŽå°ç›‘æŽ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
          (
            while true; do
              df -h | grep -E '^/dev' | head -1 | awk '{print "ç£ç›˜ä½¿ç”¨:", $3"/"$2, "("$5")"}'
              sleep 120
            done
          ) &
          local monitor_pid=$!
          
          # æ‰§è¡Œç¼–è¯‘
          if make -j$JOBS V=s \
            IGNORE_ERRORS=1 \
            BUILD_LOG=1 \
            CONFIG_AUTOREMOVE=y; then
            echo "ç¼–è¯‘æˆåŠŸ"
            kill $monitor_pid 2>/dev/null || true
            return 0
          else
            echo "å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            kill $monitor_pid 2>/dev/null || true
            make -j1 V=s
          fi
        }
        
        time compile_with_monitoring
        
        echo "ç¼–è¯‘å®Œæˆ: $(date)"
        
        # æ˜¾ç¤ºccacheç»Ÿè®¡
        echo "=== ccacheç»Ÿè®¡ ==="
        ccache --show-stats
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        echo "=== ç¼–è¯‘äº§ç‰© ==="
        ls -la bin/targets/x86/64/

    - name: Prepare artifacts
      run: |
        cd openwrt/bin/targets/x86/64
        
        # é‡å‘½åæ–‡ä»¶
        for file in openwrt-*-x86-64-generic-squashfs-combined*.img.gz; do
          if [ -f "$file" ]; then
            timestamp=$(date +%Y%m%d_%H%M)
            new_name="OpenWrt-FastBuild-${timestamp}-x86_64-generic.img.gz"
            mv "$file" "$new_name"
            echo "ç”Ÿæˆå›ºä»¶: $new_name"
            ls -lh "$new_name"
          fi
        done
        
        # åˆ›å»ºæž„å»ºä¿¡æ¯
        cat > build-info.txt << EOF
        OpenWrt Fast Build Info
        =======================
        æž„å»ºæ—¶é—´: $(date)
        æž„å»ºç”¨æ—¶: ${SECONDS}ç§’ (çº¦$((SECONDS/60))åˆ†é’Ÿ)
        ç›®æ ‡å¹³å°: x86_64 Generic
        æºç åˆ†æ”¯: $REPO_BRANCH
        
        ä¼˜åŒ–ç‰¹æ€§:
        - ccache ç¼–è¯‘ç¼“å­˜
        - å¹¶è¡Œç¼–è¯‘ ($JOBS çº¿ç¨‹)
        - æœ€å°åŒ–é…ç½®
        - å¿«é€Ÿå…‹éš†
        
        åŒ…å«è½¯ä»¶:
        - LuCI Webç®¡ç†ç•Œé¢
        - Samba4 æ–‡ä»¶å…±äº«
        - åŸºç¡€ç½‘ç»œå·¥å…·
        - OpenClash (å¦‚æžœå¯ç”¨)
        - Passwall (å¦‚æžœå¯ç”¨)
        
        é€‚ç”¨äºŽ: Win2008 R2 Hyper-V
        EOF
        
        echo "æœ€ç»ˆæ–‡ä»¶:"
        ls -la *.img.gz *.txt 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°é¢„æœŸæ–‡ä»¶"

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-x86_64-FastBuild-${{ github.run_number }}
        path: |
          openwrt/bin/targets/x86/64/*.img.gz
          openwrt/bin/targets/x86/64/build-info.txt
          openwrt/bin/targets/x86/64/*.manifest
        retention-days: 30
        compression-level: 9

    - name: Build summary
      run: |
        cd openwrt/bin/targets/x86/64
        
        {
          echo "## ðŸš€ å¿«é€Ÿç¼–è¯‘å®Œæˆ"
          echo ""
          echo "**ç¼–è¯‘æ—¶é•¿:** $((SECONDS/60)) åˆ†é’Ÿ $((SECONDS%60)) ç§’"
          echo "**å®Œæˆæ—¶é—´:** $(date)"
          echo ""
          echo "### ðŸ“¦ ç”Ÿæˆçš„å›ºä»¶"
          
          for file in *.img.gz; do
            if [ -f "$file" ]; then
              size=$(ls -lh "$file" | awk '{print $5}')
              echo "- **$file** ($size)"
            fi
          done
          
          echo ""
          echo "### âš¡ æ€§èƒ½ç»Ÿè®¡"
          echo "- **ç¼–è¯‘çº¿ç¨‹æ•°:** $(($(nproc) + 2))"
          echo "- **ccacheå‘½ä¸­çŽ‡:** $(ccache --show-stats | grep 'cache hit rate' | head -1 || echo 'æœªçŸ¥')"
          echo "- **æœ€ç»ˆç£ç›˜ä½¿ç”¨:** $(df -h | grep -E '^/dev' | head -1 | awk '{print $5}')"
          
        } >> $GITHUB_STEP_SUMMARY

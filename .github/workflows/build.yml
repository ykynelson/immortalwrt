name: Fixed OpenWrt Build for x86_64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REPO_URL: https://github.com/openwrt/openwrt
  REPO_BRANCH: openwrt-23.05
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 480
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free up maximum disk space
      run: |
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ (æ¸…ç†å‰):"
        df -h
        
        # åˆ é™¤æ‰€æœ‰ä¸å¿…è¦çš„æ–‡ä»¶
        sudo rm -rf \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache \
          /usr/local/share/boost \
          /usr/local/graalvm/ \
          /usr/local/.ghcup/ \
          /usr/local/share/powershell \
          /usr/local/share/chromium \
          /usr/local/lib/node_modules \
          /usr/share/swift \
          /var/lib/apt/lists/* \
          /tmp/* \
          /var/tmp/* \
          2>/dev/null || true
        
        # æ¸…ç†Dockerï¼ˆå¦‚æžœæœ‰ï¼‰
        sudo docker system prune -a -f 2>/dev/null || true
        
        # æ¸…ç†åŒ…ç®¡ç†å™¨
        sudo apt-get clean
        sudo apt-get autoremove -y --purge
        
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ (æ¸…ç†åŽ):"
        df -h

    - name: Setup build cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
          openwrt/dl
        key: openwrt-cache-v2-${{ hashFiles('**/feeds.conf.default') }}-${{ github.sha }}
        restore-keys: |
          openwrt-cache-v2-${{ hashFiles('**/feeds.conf.default') }}-
          openwrt-cache-v2-

    - name: Install dependencies
      run: |
        # ä½¿ç”¨æ¸…åŽé•œåƒæºåŠ é€Ÿ
        sudo sed -i 's/http:\/\/archive\.ubuntu\.com\/ubuntu\//https:\/\/mirrors\.tuna\.tsinghua\.edu\.cn\/ubuntu\//g' /etc/apt/sources.list
        
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev \
          libssl-dev python3-distutils rsync unzip zlib1g-dev \
          file wget ccache libelf-dev qemu-utils time curl \
          ca-certificates python3-setuptools python3-yaml \
          golang-go
        
        # é…ç½®ccache
        ccache --set-config=max_size=2G
        ccache --set-config=compression=true
        export PATH="/usr/lib/ccache:$PATH"

    - name: Clone OpenWrt source
      run: |
        git clone $REPO_URL -b $REPO_BRANCH openwrt --depth=1
        cd openwrt
        echo "OpenWrt ç‰ˆæœ¬ä¿¡æ¯:"
        cat package/base-files/files/etc/openwrt_release 2>/dev/null || echo "ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨"

    - name: Update feeds (with error handling)
      run: |
        cd openwrt
        
        # å¤‡ä»½åŽŸå§‹ feeds é…ç½®
        cp feeds.conf.default feeds.conf.default.bak
        
        # å¯é€‰ï¼šæ·»åŠ ç¬¬ä¸‰æ–¹æºï¼ˆæ³¨é‡ŠæŽ‰é¿å…é—®é¢˜ï¼‰
        # echo 'src-git kenzo https://github.com/kenzok8/openwrt-packages' >> feeds.conf.default
        
        echo "æ›´æ–° feeds..."
        ./scripts/feeds update -a || {
          echo "feedsæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä¿®å¤..."
          ./scripts/feeds clean
          ./scripts/feeds update -a
        }
        
        echo "å®‰è£… feeds..."
        ./scripts/feeds install -a

    - name: Generate safe configuration
      run: |
        cd openwrt
        
        # åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„é…ç½®ï¼Œé¿å…é—®é¢˜åŒ…
        cat > .config << 'EOF'
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_Generic=y
        
        # é•œåƒè®¾ç½®
        CONFIG_EFI_IMAGES=n
        CONFIG_GRUB_IMAGES=y
        CONFIG_VMDK_IMAGES=n
        CONFIG_VDI_IMAGES=n
        
        # ç¼–è¯‘ä¼˜åŒ–
        CONFIG_CCACHE=y
        CONFIG_DEVEL=y
        CONFIG_AUTOREMOVE=y
        
        # åŸºç¡€ç³»ç»Ÿ
        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-ssl=y
        CONFIG_PACKAGE_luci-mod-admin-full=y
        CONFIG_PACKAGE_luci-theme-bootstrap=y
        
        # åŸºç¡€å·¥å…·
        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget-ssl=y
        CONFIG_PACKAGE_nano=y
        CONFIG_PACKAGE_htop=y
        
        # æ–‡ä»¶å…±äº«
        CONFIG_PACKAGE_samba4-server=y
        CONFIG_PACKAGE_luci-app-samba4=y
        CONFIG_PACKAGE_wsdd2=y
        
        # ç½‘ç»œå·¥å…·
        CONFIG_PACKAGE_iperf3=y
        CONFIG_PACKAGE_tcpdump=y
        CONFIG_PACKAGE_ethtool=y
        
        # é¿å…æœ‰é—®é¢˜çš„åŒ…
        # CONFIG_PACKAGE_sing-box is not set
        # CONFIG_PACKAGE_luci-app-openclash is not set
        # CONFIG_PACKAGE_luci-app-passwall is not set
        # CONFIG_PACKAGE_luci-app-passwall2 is not set
        # CONFIG_PACKAGE_luci-app-ssr-plus is not set
        
        # ç¦ç”¨ä¸€äº›å¯èƒ½æœ‰é—®é¢˜çš„å†…æ ¸æ¨¡å—
        # CONFIG_PACKAGE_kmod-ipt-offload is not set
        EOF
        
        # ç”Ÿæˆå®Œæ•´é…ç½®
        make defconfig V=s
        
        echo "=== ç”Ÿæˆçš„é…ç½®æ£€æŸ¥ ==="
        grep "CONFIG_PACKAGE.*=y" .config | head -20

    - name: Check available packages
      run: |
        cd openwrt
        
        echo "=== æ£€æŸ¥å¯ç”¨çš„åŒ… ==="
        echo "æ£€æŸ¥ OpenClash å¯ç”¨æ€§:"
        ./scripts/feeds search openclash || echo "OpenClash ä¸å¯ç”¨"
        
        echo "æ£€æŸ¥ Passwall å¯ç”¨æ€§:"
        ./scripts/feeds search passwall || echo "Passwall ä¸å¯ç”¨"
        
        echo "æ£€æŸ¥ sing-box å¯ç”¨æ€§:"
        ./scripts/feeds search sing-box || echo "sing-box ä¸å¯ç”¨"

    - name: Add safe optional packages
      run: |
        cd openwrt
        
        # åªæ·»åŠ ç¡®å®šå­˜åœ¨ä¸”ç¨³å®šçš„åŒ…
        echo "" >> .config
        echo "# å®‰å…¨çš„å¯é€‰åŒ…" >> .config
        
        # æ£€æŸ¥å¹¶æ·»åŠ åŒ…
        if ./scripts/feeds search luci-app-upnp >/dev/null 2>&1; then
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
        fi
        
        if ./scripts/feeds search luci-app-ddns >/dev/null 2>&1; then
          echo "CONFIG_PACKAGE_luci-app-ddns=y" >> .config
        fi
        
        if ./scripts/feeds search luci-app-nlbwmon >/dev/null 2>&1; then
          echo "CONFIG_PACKAGE_luci-app-nlbwmon=y" >> .config
        fi
        
        # é‡æ–°ç”Ÿæˆé…ç½®
        make defconfig V=s

    - name: Download packages
      run: |
        cd openwrt
        
        echo "å¼€å§‹ä¸‹è½½æºç åŒ…..."
        # å¤šæ¬¡å°è¯•ä¸‹è½½
        for i in {1..3}; do
          echo "ä¸‹è½½å°è¯• $i/3"
          if make download -j$(nproc) V=s; then
            echo "ä¸‹è½½æˆåŠŸ"
            break
          else
            echo "ä¸‹è½½å¤±è´¥ï¼Œæ¸…ç†åŽé‡è¯•..."
            make clean
            sleep 5
          fi
        done
        
        # æ£€æŸ¥ä¸‹è½½å®Œæ•´æ€§
        find dl -size -1024c -exec ls -l {} \; -exec rm -f {} \;
        echo "ä¸‹è½½çš„åŒ…æ•°é‡: $(find dl -name '*.tar.*' | wc -l)"

    - name: Compile firmware (with error handling)
      run: |
        cd openwrt
        
        export PATH="/usr/lib/ccache:$PATH"
        export CCACHE_DIR=~/.ccache
        
        echo "å¼€å§‹ç¼–è¯‘ ($(nproc) çº¿ç¨‹)"
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
        
        # ç¼–è¯‘å‡½æ•°ï¼ŒåŒ…å«é”™è¯¯å¤„ç†
        compile_openwrt() {
          # å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘
          if make -j$(nproc) V=s; then
            echo "å¤šçº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            return 0
          fi
          
          echo "å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          if make -j1 V=s; then
            echo "å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
            return 0
          fi
          
          echo "ç¼–è¯‘å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯æ—¥å¿—..."
          # æŸ¥æ‰¾æœ€è¿‘çš„é”™è¯¯æ—¥å¿—
          find logs -name "*.log" -newer logs 2>/dev/null | head -5 | while read log; do
            echo "=== $log ==="
            tail -50 "$log"
            echo ""
          done
          
          return 1
        }
        
        # æ‰§è¡Œç¼–è¯‘
        if ! compile_openwrt; then
          echo "ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•è·³è¿‡å¤±è´¥çš„åŒ…..."
          make -j1 V=s IGNORE_ERRORS=1 || {
            echo "ç¼–è¯‘ä»ç„¶å¤±è´¥ï¼Œç”Ÿæˆé”™è¯¯æŠ¥å‘Š..."
            echo "é”™è¯¯æ—¶é—´: $(date)" > compile_error.log
            echo "ç£ç›˜ä½¿ç”¨: $(df -h /)" >> compile_error.log
            echo "å†…å­˜ä½¿ç”¨: $(free -h)" >> compile_error.log
            ls -la logs/*.log 2>/dev/null | head -10 >> compile_error.log
            exit 1
          }
        fi
        
        echo "ç¼–è¯‘å®Œæˆæ—¶é—´: $(date)"
        echo "ç¼–è¯‘æ€»ç”¨æ—¶: $((SECONDS/60))åˆ†é’Ÿ"
        
        # ccache ç»Ÿè®¡
        echo "=== ccache ç»Ÿè®¡ ==="
        ccache --show-stats || echo "ccacheç»Ÿè®¡å¤±è´¥"
        
        # æ£€æŸ¥è¾“å‡º
        echo "=== ç¼–è¯‘äº§ç‰© ==="
        ls -la bin/targets/x86/64/ || echo "æ²¡æœ‰æ‰¾åˆ°ç¼–è¯‘è¾“å‡º"

    - name: Check build results
      run: |
        cd openwrt
        
        if [ -d "bin/targets/x86/64" ]; then
          echo "æ‰¾åˆ°ç¼–è¯‘è¾“å‡ºç›®å½•"
          cd bin/targets/x86/64
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          echo "=== æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ ==="
          ls -la
          
          # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
          img_files=$(ls *.img.gz 2>/dev/null | wc -l)
          if [ $img_files -gt 0 ]; then
            echo "âœ… æˆåŠŸç”Ÿæˆ $img_files ä¸ªå›ºä»¶æ–‡ä»¶"
            for file in *.img.gz; do
              size=$(ls -lh "$file" | awk '{print $5}')
              echo "  - $file ($size)"
            done
          else
            echo "âŒ æ²¡æœ‰æ‰¾åˆ° .img.gz å›ºä»¶æ–‡ä»¶"
            echo "å°è¯•æŸ¥æ‰¾å…¶ä»–æ ¼å¼çš„æ–‡ä»¶:"
            ls -la *.img 2>/dev/null || echo "æ²¡æœ‰ .img æ–‡ä»¶"
            ls -la *.bin 2>/dev/null || echo "æ²¡æœ‰ .bin æ–‡ä»¶"
          fi
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°ç¼–è¯‘è¾“å‡ºç›®å½•"
          echo "æŸ¥çœ‹ bin ç›®å½•ç»“æž„:"
          find bin -type f 2>/dev/null | head -20
        fi

    - name: Prepare artifacts
      run: |
        cd openwrt
        
        if [ -d "bin/targets/x86/64" ]; then
          cd bin/targets/x86/64
          
          # é‡å‘½åæ–‡ä»¶
          for file in *.img.gz; do
            if [ -f "$file" ]; then
              timestamp=$(date +%Y%m%d_%H%M)
              new_name="OpenWrt-Stable-${timestamp}-x86_64-generic.img.gz"
              mv "$file" "$new_name"
              echo "ç”Ÿæˆå›ºä»¶: $new_name"
            fi
          done
          
          # åˆ›å»ºæž„å»ºä¿¡æ¯
          cat > build-info.txt << EOF
        OpenWrt ç¨³å®šç‰ˆæž„å»ºä¿¡æ¯
        =======================
        æž„å»ºæ—¶é—´: $(date)
        æž„å»ºç”¨æ—¶: $((SECONDS/60))åˆ†é’Ÿ
        ç›®æ ‡å¹³å°: x86_64 Generic  
        OpenWrtç‰ˆæœ¬: $REPO_BRANCH
        
        ç‰¹ç‚¹:
        - ä¸“ä¸º Win2008 R2 Hyper-V ä¼˜åŒ–
        - é¿å…äº†æœ‰é—®é¢˜çš„åŒ…
        - åŒ…å«åŸºç¡€ç®¡ç†ç•Œé¢å’Œå·¥å…·
        - æ”¯æŒæ–‡ä»¶å…±äº« (Samba4)
        
        åŒ…å«çš„ä¸»è¦åŠŸèƒ½:
        - LuCI Webç®¡ç†ç•Œé¢
        - Samba4 æ–‡ä»¶å…±äº«æœåŠ¡
        - åŸºç¡€ç½‘ç»œå·¥å…·
        - ç³»ç»Ÿç›‘æŽ§å·¥å…·
        
        å®‰è£…è¯´æ˜Ž:
        1. è§£åŽ‹ .img.gz æ–‡ä»¶
        2. åœ¨ Hyper-V ä¸­åˆ›å»ºè™šæ‹Ÿæœº
        3. ä½¿ç”¨è§£åŽ‹åŽçš„ .img æ–‡ä»¶ä½œä¸ºç£ç›˜
        4. å¯åŠ¨è™šæ‹Ÿæœº
        EOF
        
        else
          echo "æ²¡æœ‰æ‰¾åˆ°ç¼–è¯‘è¾“å‡ºï¼Œåˆ›å»ºé”™è¯¯æŠ¥å‘Š..."
          mkdir -p error_report
          echo "ç¼–è¯‘å¤±è´¥äºŽ: $(date)" > error_report/build-error.txt
          echo "æž„å»ºæ—¥å¿—:" >> error_report/build-error.txt
          find ../../../logs -name "*.log" 2>/dev/null | head -5 | while read log; do
            echo "=== $(basename $log) ===" >> error_report/build-error.txt
            tail -100 "$log" >> error_report/build-error.txt
            echo "" >> error_report/build-error.txt
          done
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-x86_64-Stable-${{ github.run_number }}
        path: |
          openwrt/bin/targets/x86/64/*.img.gz
          openwrt/bin/targets/x86/64/build-info.txt
          openwrt/bin/targets/x86/64/*.manifest
          openwrt/error_report/*
        retention-days: 30
        if-no-files-found: warn

    - name: Build summary
      run: |
        cd openwrt
        
        {
          echo "## ðŸ”§ OpenWrt ç¼–è¯‘ç»“æžœ"
          echo ""
          echo "**æž„å»ºæ—¶é•¿:** $((SECONDS/60)) åˆ†é’Ÿ"
          echo "**å®Œæˆæ—¶é—´:** $(date)"
          echo ""
          
          if [ -d "bin/targets/x86/64" ]; then
            cd bin/targets/x86/64
            echo "### âœ… ç¼–è¯‘æˆåŠŸ"
            echo ""
            echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
            for file in *.img.gz; do
              if [ -f "$file" ]; then
                size=$(ls -lh "$file" | awk '{print $5}')
                echo "- **$file** ($size)"
              fi
            done
          else
            echo "### âŒ ç¼–è¯‘å¤±è´¥"
            echo ""
            echo "è¯·æŸ¥çœ‹ Actions æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          fi
          
          echo ""
          echo "### ðŸ“‹ é…ç½®è¯´æ˜Ž" 
          echo "- ç›®æ ‡å¹³å°: x86_64 Generic"
          echo "- é€‚é…: Win2008 R2 Hyper-V"
          echo "- é¿å…äº† sing-box ç­‰é—®é¢˜åŒ…"
          echo "- åŒ…å«ç¨³å®šçš„åŸºç¡€åŠŸèƒ½"
          
        } >> $GITHUB_STEP_SUMMARY
